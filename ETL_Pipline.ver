import pandas as pd
import matplotlib.pyplot as plt
import sqlite3


# ==============================
# 1. Extract
# ==============================

RAW_PATH = r"C:\Users\dldud\Downloads\games_march2025_cleaned.csv"
CLEAN_PATH = r"C:\Users\dldud\Downloads\steam_games_cleaned.csv"
DB_PATH = r"C:\Users\dldud\Downloads\steam_games.db"

print("Loading raw data...")
df = pd.read_csv(RAW_PATH, encoding='utf-8')
print(df.info())


# ==============================
# 2. Transform
# ==============================

# í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì¶”ì¶œ
cols = [
    'appid', 'name', 'release_date', 'price',
    'developers', 'publishers', 'genres', 'categories',
    'positive', 'negative', 'num_reviews_total',
    'discount', 'peak_ccu',
    'pct_pos_total'
]

df_main = df[cols].copy()

# ë‚ ì§œ ë³€í™˜
df_main['release_date'] = pd.to_datetime(df_main['release_date'], errors='coerce')

# ì „ì²´ ê¸ì •ë¥  â†’ positive_rateë¡œ ì‚¬ìš©
df_main['positive_rate'] = df_main['pct_pos_total']

# ì¶œì‹œ ì—°ë„ ìƒì„±
df_main['release_year'] = df_main['release_date'].dt.year

# ìˆ˜ìµ ì¶”ì •ì¹˜ ìƒì„±
df_main['est_revenue'] = df_main['price'] * df_main['num_reviews_total']


# ==============================
# 3. Load (CSV ì €ì¥)
# ==============================

df_main.to_csv(CLEAN_PATH, index=False)
print(f"Cleaned data saved to: {CLEAN_PATH}")


# ==============================
# 4. Data Quality Check (QA)
# ==============================

print("\n=== ğŸ§ª Data Quality Check ===")
print("Null values:\n", df_main.isnull().sum())
print("\nDuplicated rows:", df_main.duplicated().sum())
print("\nSummary statistics:\n", df_main.describe())


# ==============================
# 5. ê¸°ë³¸ QA ì‹œê°í™”
# ==============================

# (1) ì—°ë„ë³„ ì¶œì‹œ ì¶”ì´
plt.figure(figsize=(10, 4))
df_main.groupby('release_year')['appid'].count().plot(kind='bar')
plt.title("Number of Games Released by Year (QA)")
plt.xlabel("Release Year")
plt.ylabel("Game Count")
plt.tight_layout()
plt.show()

# (2) ë¦¬ë·° ìˆ˜ vs ê¸ì •ë¥ 
plt.figure(figsize=(8, 5))
plt.scatter(df_main['num_reviews_total'], df_main['positive_rate'], alpha=0.3)
plt.xscale('log')
plt.xlabel("Number of Reviews (log scale)")
plt.ylabel("Positive Rate (%)")
plt.title("Review Volume vs Positive Rate")
plt.tight_layout()
plt.show()


# ==============================
# 6. Load to SQLite DB
# ==============================

print("\n Creating SQLite DB...")
conn = sqlite3.connect(DB_PATH)

df_main.to_sql('steam_games', conn, if_exists='replace', index=False)
print(f"Data loaded into SQLite DB: {DB_PATH}")

# ==============================
# 7. SQL Query Validation
# ==============================

query = """
SELECT 
    release_year, 
    COUNT(*) AS game_count, 
    AVG(price) AS avg_price
FROM steam_games
GROUP BY release_year
ORDER BY release_year;
"""

print("\n=== SQL Query Result ===")
print(pd.read_sql_query(query, conn).head())

conn.close()
print("\n ETL Pipeline Completed!")
